{% extends 'turnos/base.html' %}

{% block title %}Operador V{{ numero_ventanilla }} - SEP{% endblock %}

{% block header_subtitle %}PANEL DE OPERADOR{% endblock %}

{% block extra_css %}
<style>
    /* Estilos del Panel de Control */
    .operador-layout {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .info-header {
        background: #333;
        color: white;
        padding: 15px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    /* ZONA DE ACCI√ìN CENTRAL */
    .zona-accion {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        min-height: 300px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    /* ESTADO: ESPERANDO (LIBRE) */
    .estado-libre .icono { font-size: 60px; margin-bottom: 20px; opacity: 0.5; }
    .estado-libre h2 { color: #666; margin-bottom: 30px; }

    /* ESTADO: LLAMANDO */
    .estado-llamando { border-color: var(--guinda); }
    .dato-turno { font-size: 4rem; font-weight: 800; color: var(--guinda); margin: 10px 0; }
    .dato-nombre { font-size: 2rem; font-weight: 600; color: #333; margin-bottom: 10px; }
    .badge-intentos { background: #ff9800; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; }

    /* ESTADO: EN ATENCI√ìN */
    .estado-atencion { border-color: #2e7d32; background: #f1f8e9; }
    .timer { font-family: monospace; font-size: 1.5rem; color: #2e7d32; margin-top: 20px; }

    /* BOTONES GIGANTES */
    .btn-accion {
        padding: 15px 40px;
        font-size: 1.2rem;
        border-radius: 50px;
        border: none;
        cursor: pointer;
        transition: transform 0.1s;
        margin: 10px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }
    .btn-accion:active { transform: scale(0.98); }

    .btn-llamar { background: var(--guinda); color: white; width: 100%; max-width: 400px; justify-content: center;}
    .btn-rellamar { background: #ff9800; color: white; }
    .btn-atender { background: #2e7d32; color: white; }
    .btn-noshow { background: #d32f2f; color: white; }
    .btn-finalizar { background: #333; color: white; width: 100%; max-width: 400px; justify-content: center;}

    .hidden { display: none !important; }

</style>
{% endblock %}

{% block content %}
<div class="operador-layout">
    
    <div class="info-header">
        <h2 style="margin:0;">Ventanilla {{ numero_ventanilla }}</h2>
        <div id="statusBagde" style="background:#4CAF50; padding:5px 15px; border-radius:4px; font-size:0.9rem">DISPONIBLE</div>
    </div>

    <div id="pantallaLibre" class="zona-accion estado-libre">
        <div class="icono">üì¢</div>
        <h2>Ventanilla Disponible</h2>
        <button class="btn-accion btn-llamar" onclick="llamarSiguiente()">
            LLAMAR SIGUIENTE TURNO
        </button>
        <p id="msgError" style="color:red; margin-top:10px; display:none;"></p>
    </div>

    <div id="pantallaLlamando" class="zona-accion estado-llamando hidden">
        <span class="badge-intentos">Llamando: Intento <span id="txtIntentos">1</span>/3</span>
        
        <div class="dato-turno" id="txtTurno">-</div>
        <div class="dato-nombre" id="txtNombre">-</div>

        <div style="margin-top: 30px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <button class="btn-accion btn-rellamar" onclick="rellamar()">
                üîî Volver a llamar
            </button>
            <button class="btn-accion btn-atender" onclick="iniciarAtencion()">
                ‚úÖ CIUDADANO LLEG√ì
            </button>
        </div>
        <div style="margin-top: 10px;">
            <button class="btn-accion btn-noshow" onclick="finalizarTurno('NO_SHOW')" style="font-size: 0.9rem; padding: 10px 20px;">
                ‚ùå No se present√≥
            </button>
        </div>
    </div>

    <div id="pantallaAtencion" class="zona-accion estado-atencion hidden">
        <h3 style="color:#2e7d32; margin:0;">EN ATENCI√ìN</h3>
        <div class="dato-turno" id="txtTurnoAtencion" style="color:#2e7d32; font-size: 3rem;">-</div>
        <div class="dato-nombre" id="txtNombreAtencion" style="font-size: 1.5rem;">-</div>
        
        <div class="timer" id="cronometro">00:00</div>

        <div style="margin-top: 40px; width: 100%;">
            <button class="btn-accion btn-finalizar" onclick="finalizarTurno('FINALIZADO')">
                üèÅ FINALIZAR TR√ÅMITE
            </button>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables de Estado Local
    const VENTANILLA_ID = Number("{{ numero_ventanilla }}");
    let turnoActual = null;
    let timerInterval;
    let segundosTranscurridos = 0;

    // --- FUNCIONES API ---

    async function llamarSiguiente() {
        try {
            const res = await fetch('/api/turnos/llamar/', {
                method: 'POST',
                body: JSON.stringify({ ventanilla: VENTANILLA_ID })
            });
            const data = await res.json();
            
            if (data.success) {
                turnoActual = data.turno; // Guardamos el objeto turno
                mostrarPantalla('LLAMANDO');
                actualizarDatosUI();
            } else {
                mostrarError(data.message || "No hay turnos");
            }
        } catch (e) { console.error(e); }
    }

    async function rellamar() {
        if(!turnoActual) return;
        
        // Optimista: actualizamos UI primero
        turnoActual.intentos++;
        actualizarDatosUI();

        await fetch('/api/turnos/rellamar/', {
            method: 'POST',
            body: JSON.stringify({ turno_id: turnoActual.id })
        });
    }

    async function iniciarAtencion() {
        if(!turnoActual) return;

        await fetch('/api/turnos/atencion/', {
            method: 'POST',
            body: JSON.stringify({ turno_id: turnoActual.id })
        });

        mostrarPantalla('ATENCION');
        iniciarCronometro();
    }

    async function finalizarTurno(motivo) {
        if(!turnoActual) return;

        await fetch('/api/turnos/finalizar/', {
            method: 'POST',
            body: JSON.stringify({ 
                turno_id: turnoActual.id,
                tipo: motivo // 'FINALIZADO' o 'NO_SHOW'
            })
        });

        detenerCronometro();
        turnoActual = null;
        mostrarPantalla('LIBRE');
    }

    // --- MANEJO DE UI ---

    function mostrarPantalla(estado) {
        // Ocultar todas
        document.getElementById('pantallaLibre').classList.add('hidden');
        document.getElementById('pantallaLlamando').classList.add('hidden');
        document.getElementById('pantallaAtencion').classList.add('hidden');
        document.getElementById('msgError').style.display = 'none';

        const badge = document.getElementById('statusBagde');

        if(estado === 'LIBRE') {
            document.getElementById('pantallaLibre').classList.remove('hidden');
            badge.innerText = "DISPONIBLE";
            badge.style.background = "#4CAF50";
        } 
        else if (estado === 'LLAMANDO') {
            document.getElementById('pantallaLlamando').classList.remove('hidden');
            badge.innerText = "LLAMANDO...";
            badge.style.background = "#ff9800";
        }
        else if (estado === 'ATENCION') {
            document.getElementById('pantallaAtencion').classList.remove('hidden');
            badge.innerText = "OCUPADO";
            badge.style.background = "#f44336";
        }
    }

    function actualizarDatosUI() {
        if(!turnoActual) return;
        
        // Pantalla Llamando
        document.getElementById('txtTurno').innerText = turnoActual.numero;
        document.getElementById('txtNombre').innerText = turnoActual.nombre;
        document.getElementById('txtIntentos').innerText = turnoActual.intentos || 1;

        // Pantalla Atencion
        document.getElementById('txtTurnoAtencion').innerText = turnoActual.numero;
        document.getElementById('txtNombreAtencion').innerText = turnoActual.nombre;
    }

    function mostrarError(msg) {
        const el = document.getElementById('msgError');
        el.innerText = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }

    // --- CRON√ìMETRO SIMPLE ---
    function iniciarCronometro() {
        segundosTranscurridos = 0;
        document.getElementById('cronometro').innerText = "00:00";
        timerInterval = setInterval(() => {
            segundosTranscurridos++;
            const min = Math.floor(segundosTranscurridos / 60).toString().padStart(2, '0');
            const sec = (segundosTranscurridos % 60).toString().padStart(2, '0');
            document.getElementById('cronometro').innerText = `${min}:${sec}`;
        }, 1000);
    }

    function detenerCronometro() {
        clearInterval(timerInterval);
    }

</script>
{% endblock %}