{% extends 'turnos/base.html' %}
{% load static %}

{% block title %}Operador V{{ numero_ventanilla }} - SEP{% endblock %}

{% block header_subtitle %}PANEL DE CONTROL{% endblock %}

{% block extra_css %}
<style>
    /* --- ESTRUCTURA FULL HEIGHT (Sin Scroll) --- */
    body { 
        background-color: #f4f6f8; 
        overflow: hidden; /* Adi√≥s barra de scroll */
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    /* El bloque 'content' hereda el flex del body en base.html si est√° bien hecho, 
       pero por seguridad forzamos el contenedor principal */
    .operador-container {
        height: calc(100vh - 120px); /* Restamos aprox la altura del header SEP */
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px; /* Espacio entre el header de estado y la tarjeta */
        box-sizing: border-box;
    }

    /* TARJETA DE ESTADO (ENCABEZADO) */
    .status-card {
        background: white;
        border-radius: 12px;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border-left: 6px solid #ccc;
        flex-shrink: 0; /* No permitimos que se encoja */
    }

    .status-info h2 { margin: 0; font-size: 1.4rem; color: #333; }
    .status-info p { margin: 0; color: #666; font-size: 0.9rem; }
    
    .status-badge {
        padding: 6px 15px;
        border-radius: 50px;
        font-weight: 800;
        font-size: 0.85rem;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: white;
        background: #999;
    }

    /* --- ZONAS DE ACCI√ìN (FLEXIBLES) --- */
    .action-zone {
        display: none;
        background: white;
        border-radius: 16px;
        padding: 20px; /* Padding reducido para ganar espacio */
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        
        /* MAGIA FLEX: Llenar el resto de la pantalla */
        flex: 1; 
        flex-direction: column;
        justify-content: center; /* Centrar verticalmente */
        align-items: center;
        
        overflow-y: auto; /* Solo scroll aqu√≠ si es MUY necesario */
    }

    .action-zone.active { display: flex; }

    /* ESTADO: DISPONIBLE */
    .zone-libre .icon-big { font-size: 4rem; color: #4CAF50; margin-bottom: 15px; display: block; }
    .zone-libre h3 { font-size: 1.8rem; color: #333; margin-bottom: 30px; }

    /* ESTADO: LLAMANDO */
    .zone-llamando .ticket-number { font-size: clamp(3rem, 8vh, 5rem); font-weight: 900; color: var(--guinda); line-height: 1; margin-bottom: 10px; }
    .zone-llamando .citizen-name { font-size: clamp(1.2rem, 3vh, 1.8rem); color: #333; margin-bottom: 20px; font-weight: 600; }
    .zone-llamando .intentos-wrapper { margin-bottom: 20px; }
    .zone-llamando .badge-intento { background: #ff9800; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }

    /* ESTADO: ATENCI√ìN */
    .zone-atencion { border-top: 6px solid #2e7d32; }
    .timer-display { 
        font-family: 'Courier New', monospace; 
        font-size: clamp(3rem, 6vh, 4rem); /* Timer responsivo */
        font-weight: 700; 
        color: #2e7d32; 
        background: #f1f8e9;
        display: inline-block;
        padding: 10px 40px;
        border-radius: 10px;
        margin: 20px 0 30px 0;
        border: 2px solid #c8e6c9;
    }

    /* BOTONES MODERNOS Y COMPACTOS */
    .btn-action {
        border: none;
        padding: 15px 30px; /* Un poco menos padding */
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.2s;
        display: inline-flex; align-items: center; justify-content: center; gap: 10px;
        width: 100%; max-width: 320px;
        margin: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-action:active { transform: scale(0.98); }

    .btn-green { background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); color: white; box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3); }
    .btn-green:hover { box-shadow: 0 10px 20px rgba(76, 175, 80, 0.4); transform: translateY(-2px); }

    .btn-orange { background: white; color: #f57c00; border: 2px solid #f57c00; }
    .btn-orange:hover { background: #fff3e0; }

    .btn-red { background: #ffebee; color: #d32f2f; border: 2px solid #ef9a9a; padding: 12px 20px; font-size: 0.85rem; }
    .btn-red:hover { background: #ffcdd2; }

    .btn-dark { background: #333; color: white; }
    .btn-dark:hover { background: #000; }

    /* Colores de Estado */
    .border-libre { border-left-color: #4CAF50 !important; }
    .border-llamando { border-left-color: #ff9800 !important; }
    .border-atencion { border-left-color: #d32f2f !important; }

</style>
{% endblock %}

{% block content %}
<div class="operador-container">
    
    <div id="statusBar" class="status-card border-libre">
        <div class="status-info">
            <h2>Ventanilla {{ numero_ventanilla }}</h2>
            <p id="statusText">Esperando acci√≥n...</p>
        </div>
        <div id="statusBadge" class="status-badge" style="background: #4CAF50;">DISPONIBLE</div>
    </div>

    <div id="viewLibre" class="action-zone zone-libre active">
        <div>
            <span class="icon-big">üì¢</span>
            <h3>Ventanilla Disponible</h3>
            <button class="btn-action btn-green" onclick="llamarSiguiente()">
                <span>üîî</span> LLAMAR SIGUIENTE
            </button>
        </div>
    </div>

    <div id="viewLlamando" class="action-zone zone-llamando">
        <div style="width: 100%;">
            <div class="intentos-wrapper">
                <span class="badge-intento">INTENTO <span id="lblIntentos">1</span> DE 3</span>
            </div>
            
            <div class="ticket-number" id="lblTurnoLlamando">---</div>
            <div class="citizen-name" id="lblNombreLlamando">---</div>
            <p style="color:#888; margin-bottom: 20px;">Esperando al ciudadano...</p>

            <div style="display:flex; flex-direction:column; align-items:center;">
                <button class="btn-action btn-green" onclick="iniciarAtencion()">
                    ‚úÖ CIUDADANO LLEG√ì
                </button>
                <div style="display:flex; gap:10px; width:100%; max-width:320px; justify-content:center; margin-top:5px;">
                    <button class="btn-action btn-orange" style="flex:1;" onclick="rellamar()">
                        üîä RE-LLAMAR
                    </button>
                    <button class="btn-action btn-red" style="flex:1;" onclick="finalizarTurno('NO_SHOW')">
                        ‚ùå NO LLEG√ì
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="viewAtencion" class="action-zone zone-atencion">
        <div>
            <p style="text-transform:uppercase; letter-spacing:2px; color:#2e7d32; font-weight:bold; margin-bottom:10px;">En Atenci√≥n</p>
            <div style="font-size:clamp(2rem, 5vh, 3.5rem); font-weight:800; color:#333;" id="lblTurnoAtencion">---</div>
            <div style="font-size:1.2rem; color:#666;" id="lblNombreAtencion">---</div>

            <div class="timer-display" id="cronometro">00:00</div>

            <button class="btn-action btn-dark" onclick="finalizarTurno('FINALIZADO')">
                üèÅ FINALIZAR TR√ÅMITE
            </button>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- VARIABLES GLOBALES ---
    const VENTANILLA_ID = Number("{{ numero_ventanilla }}");
    let turnoActual = null;
    let timerInterval;
    let segundos = 0;

    // --- L√ìGICA DE API ---

    async function llamarSiguiente() {
        try {
            const res = await fetch('/api/turnos/llamar/', {
                method: 'POST',
                body: JSON.stringify({ ventanilla: VENTANILLA_ID })
            });
            const data = await res.json();
            
            if (data.success) {
                turnoActual = data.turno;
                actualizarInterfaz('LLAMANDO');
            } else {
                alert("üì≠ " + (data.message || "No hay turnos en espera"));
            }
        } catch (e) { console.error(e); alert("Error de conexi√≥n"); }
    }

    async function rellamar() {
        if(!turnoActual) return;
        turnoActual.intentos++; 
        document.getElementById('lblIntentos').innerText = turnoActual.intentos;
        
        await fetch('/api/turnos/rellamar/', {
            method: 'POST',
            body: JSON.stringify({ turno_id: turnoActual.id })
        });
    }

    async function iniciarAtencion() {
        if(!turnoActual) return;
        
        await fetch('/api/turnos/atencion/', {
            method: 'POST',
            body: JSON.stringify({ turno_id: turnoActual.id })
        });
        
        actualizarInterfaz('ATENCION');
    }

    async function finalizarTurno(motivo) {
        if(!turnoActual) return;

        await fetch('/api/turnos/finalizar/', {
            method: 'POST',
            body: JSON.stringify({ turno_id: turnoActual.id, tipo: motivo })
        });

        turnoActual = null;
        actualizarInterfaz('LIBRE');
    }

    // --- MANEJO DE INTERFAZ ---

    function actualizarInterfaz(estado) {
        const views = {
            'LIBRE': document.getElementById('viewLibre'),
            'LLAMANDO': document.getElementById('viewLlamando'),
            'ATENCION': document.getElementById('viewAtencion')
        };
        const statusBar = document.getElementById('statusBar');
        const badge = document.getElementById('statusBadge');
        const statusText = document.getElementById('statusText');

        Object.values(views).forEach(el => el.classList.remove('active'));
        detenerCronometro();

        if (estado === 'LIBRE') {
            views['LIBRE'].classList.add('active');
            statusBar.className = 'status-card border-libre';
            badge.style.background = '#4CAF50';
            badge.innerText = 'DISPONIBLE';
            statusText.innerText = 'Listo para llamar.';
        } 
        else if (estado === 'LLAMANDO') {
            views['LLAMANDO'].classList.add('active');
            document.getElementById('lblTurnoLlamando').innerText = turnoActual.numero;
            document.getElementById('lblNombreLlamando').innerText = turnoActual.nombre;
            document.getElementById('lblIntentos').innerText = turnoActual.intentos || 1;

            statusBar.className = 'status-card border-llamando';
            badge.style.background = '#ff9800';
            badge.innerText = 'LLAMANDO';
            statusText.innerText = 'Esperando ciudadano...';
        } 
        else if (estado === 'ATENCION') {
            views['ATENCION'].classList.add('active');
            iniciarCronometro();
            document.getElementById('lblTurnoAtencion').innerText = turnoActual.numero;
            document.getElementById('lblNombreAtencion').innerText = turnoActual.nombre;

            statusBar.className = 'status-card border-atencion';
            badge.style.background = '#d32f2f';
            badge.innerText = 'OCUPADO';
            statusText.innerText = 'Tr√°mite en curso.';
        }
    }

    function iniciarCronometro() {
        segundos = 0;
        const display = document.getElementById('cronometro');
        display.innerText = "00:00";
        timerInterval = setInterval(() => {
            segundos++;
            const min = Math.floor(segundos / 60).toString().padStart(2, '0');
            const sec = (segundos % 60).toString().padStart(2, '0');
            display.innerText = `${min}:${sec}`;
        }, 1000);
    }

    function detenerCronometro() { clearInterval(timerInterval); }
</script>
{% endblock %}